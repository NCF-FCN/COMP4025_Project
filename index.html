<!DOCTYPE html>
<html>

<treeGroup>
    <meta charset=utf-8>
    <title>Gun Shooting Simulation</title>
    <style>
        body {
            margin: 0;
            padding: 0px;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        #toggleSidebar {
            position: fixed;
            top: 20px;
            left: 0px;
            padding: 20px;
            transition: left 0.5s;
        }

        #sidebar {
            position: fixed;
            top: 0px;
            left: -160px;
            width: 160px;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            transition: left 0.5s;
        }

        #toggleSidebar.open {
            left: 160px;
        }

        #sidebar.open {
            left: 0px;
        }

        #switchMap {
            padding: 20px;
        }
    </style>
</treeGroup>

<body>
    <button id="toggleSidebar">&#9776;</button>

    <div id="sidebar">
        <button id="switchMap">Switch Map</button>
        <button id="loadAWP">Load AWP</button>
        <button id="loadGlock">Load Glock</button>
        <button id="loadM249">Load M249</button>
    </div>

    <script src="js/three.js"></script>
    <script src="js/loaders/GLTFLoader.js"></script>
    <script src="js/shared/player_shared.js"></script>
    <script src="js/map/forest.js"></script>
    <script src="js/map/warehouse.js"></script>
    <script>
        document.getElementById("toggleSidebar").addEventListener("click", function () {
            const sidebar = document.getElementById("sidebar");
            const toggleSidebar = document.getElementById("toggleSidebar");

            if (sidebar.classList.contains("open")) {
                toggleSidebar.classList.remove("open");
                sidebar.classList.remove("open");
            } else {
                toggleSidebar.classList.add("open");
                sidebar.classList.add("open");
            }
        });
    </script>
    <script>
        let scene, camera, controls, loadedModel, totalModel;
        let aspect = window.innerWidth / window.innerHeight;
        let renderer = new THREE.WebGLRenderer();

        document.getElementById("switchMap").addEventListener("click", function () {
            //check the loading progress
            if (loadedModel < totalModel) {
                alert("Please wait for the map to load and press the button again.");
                return;
            }

            //choose which map to load and set the total model amount
            if (scene.name === "forest") {
                totalModel = 14;
                loadWarehouse();
            } else {
                totalModel = 7;
                loadForest();
            }
        });

        //free up the RAM
        function disposeNode(node) {
            if (node instanceof THREE.Mesh) {
                if (node.geometry) node.geometry.dispose();

                if (node.material) {
                    if (node.material instanceof THREE.MeshFaceMaterial || node.material instanceof THREE.MultiMaterial) {
                        node.material.materials.forEach(function (mtrl, idx) {
                            if (mtrl.map) mtrl.map.dispose();
                            if (mtrl.lightMap) mtrl.lightMap.dispose();
                            if (mtrl.bumpMap) mtrl.bumpMap.dispose();
                            if (mtrl.normalMap) mtrl.normalMap.dispose();
                            if (mtrl.specularMap) mtrl.specularMap.dispose();
                            if (mtrl.envMap) mtrl.envMap.dispose();
                            mtrl.dispose();
                        });
                    } else {
                        if (node.material.map) node.material.map.dispose();
                        if (node.material.lightMap) node.material.lightMap.dispose();
                        if (node.material.bumpMap) node.material.bumpMap.dispose();
                        if (node.material.normalMap) node.material.normalMap.dispose();
                        if (node.material.specularMap) node.material.specularMap.dispose();
                        if (node.material.envMap) node.material.envMap.dispose();
                        node.material.dispose();
                    }
                }
            }
        }

        function mapPrepare() {
            //clean the scene
            if (scene) {
                while (scene.children.length > 0) {
                    scene.remove(scene.children[0]);
                    scene.traverse(disposeNode);
                    renderer.clear();
                }
            }

            // reset loadedModel
            loadedModel = 0;

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87cefa);

            // Camera
            camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 10000);

            // Renderer
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.gammaOutput = true;
            // renderer.shadowMap.enabled = true;
            // renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);
        }

        //load warehouse first
        loadWarehouse();
    </script>
</body>

</html>
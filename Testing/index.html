<!DOCTYPE html>
<html>

<bolt>
    <meta charset=utf-8>
    <title>Gun</title>
    <style>
        body {
            margin: 0;
            padding: 0px;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
        }
    </style>
</bolt>

<body>
    <script src="js/three.js"></script>
    <script src="js/loaders/GLTFLoader.js"></script>
    <script>
        // Scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87cefa);

        // Camera
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 500000);

        // Renderer
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 10);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff);
        directionalLight.position.set(0, 40, 100);
        scene.add(directionalLight);

        //gunGroup
        const gunGroup = new THREE.Group();
        scene.add(gunGroup);

        // GLTF Loader
        const gltfLoader = new THREE.GLTFLoader();

        let gunBolt;
        let gunBullet;
        let gunBody;
        let gunTrigger;

        new THREE.GLTFLoader().load("models/gun/9mm/body/scene.glb", function (gltf) {
            gunBody = gltf.scene;
            shader(gunBody);
            gunGroup.add(gunBody);
        }, undefined, function (error) {
            console.error(error);
        });

        new THREE.GLTFLoader().load("models/gun/9mm/bolt/scene.glb", function (gltf) {
            gunBolt = gltf.scene;
            shader(gunBolt);
            gunGroup.add(gunBolt);
        }, undefined, function (error) {
            console.error(error);
        });

        new THREE.GLTFLoader().load("models/gun/9mm/trigger/scene.glb", function (gltf) {
            gunTrigger = gltf.scene;
            shader(gunTrigger);
            gunGroup.add(gunTrigger);
            gunTrigger.position.set(-17, 112, 0);
        }, undefined, function (error) {
            console.error(error);
        });

        new THREE.GLTFLoader().load("models/gun/9mm/bullet/scene.glb", function (gltf) {
            gunBullet = gltf.scene;
            gunBullet.position.set(0, 140, 0);
        }, undefined, function (error) {
            console.error(error);
        });

        // Apply shader to loaded object
        function shader(object) {
            const shaderLoader = new THREE.FileLoader();

            shaderLoader.load('shader/vertex.glsl', function (vertexShader) {
                shaderLoader.load('shader/fragment.glsl', function (fragmentShader) {
                    object.traverse(function (child) {
                        child.castShadow = true;

                        if (child.isMesh) {
                            child.material = new THREE.ShaderMaterial({
                                uniforms: {
                                    lightSrc: { type: "v3", value: directionalLight.position },
                                    texture: { type: "t", value: child.material.map }
                                },
                                vertexShader: vertexShader,
                                fragmentShader: fragmentShader
                            });
                        }
                    });
                });
            });
        }

        camera.position.set(900, 100, 300);
        // camera.rotation.y = 0.5;
        camera.lookAt(gunGroup.position);

        //keybinding and animation
        let isAnimating = false;

        function onKeyDown(event) {
            event.preventDefault();

            if (event.keyCode === 32 && !isAnimating) { // Spacebar key
                isAnimating = true;
                const gunBulletClone = gunBullet.clone();

                const pressTime = Date.now();
                const gunGroup_duration = 100; //0.1 sec
                const gunBolt_duration = 100; //0.1 sec
                const gunTrigger_duration = 200; //0.2 sec
                const gunBullet_duation = 100; //0.1 sec

                let r_gunGroup_now = null, r_gunBolt_now = null, r_gunTrigger_now = null;
                const r_gunGroup_duration = 150; //0.15 sec
                const r_gunBolt_duration = 200; //0.2 sec
                const r_gunTrigger_duration = 200; //0.2 sec

                const audio = new Audio("sound/9mm_sound.mp3");
                audio.play();

                // console.log("Press Time: " + pressTime);
                function animateGun() {
                    const now = Date.now();
                    let gunGroup_progress = (now - pressTime) / gunGroup_duration; //((Time now - Time start) / Time) It will used for animation
                    let gunBolt_progress = (now - pressTime) / gunBolt_duration;
                    let gunTrigger_progress = (now - pressTime) / gunTrigger_duration;
                    let gunBullet_process = (now - pressTime) / gunBullet_duation;

                    if (gunBullet_process >= 1) gunBullet_process = 1;
                    if (gunBullet_process < 1) {
                        scene.add(gunBulletClone);
                        gunBulletClone.position.x = 1000 * gunBullet_process;
                    } else {
                        scene.remove(gunBulletClone);
                    }

                    if (gunGroup_progress <= 1) {
                        gunGroup.rotation.z = 0.3 * gunGroup_progress; //finish rotate angle * time based progress (%)
                        gunGroup.position.x = -100 * gunGroup_progress; //finish position * time based progress (%)

                        // console.log("Now: " + now + ", gunGroup_progress: " + gunGroup_progress + ", gunGroup.rotation.z: " + gunGroup.rotation.z + ", gunGroup.position.x: " + gunGroup.position.x);
                    } else {
                        gunGroup.rotation.z = 0.3;  //if gunGroup_progress > 1,
                        gunGroup.position.x = -100; //just set to 100% because setting cannot exceed setting

                        //start reverse
                        if (!r_gunGroup_now) {
                            r_gunGroup_now = Date.now();
                        }

                        const r_gunGroup_progress = (now - r_gunGroup_now) / r_gunGroup_duration;

                        if (r_gunGroup_progress <= 1) {
                            gunGroup.rotation.z = 0.3 * (1 - r_gunGroup_progress);
                            gunGroup.position.x = -100 * (1 - r_gunGroup_progress);
                        } else {
                            gunGroup.rotation.z = 0;
                            gunGroup.position.x = 0;
                        }

                        // console.log("Now: " + now + ", r_gunGroup_now" + r_gunGroup_now + ", r_gunGroup_progress: " + r_gunGroup_progress + ", gunGroup.rotation.z: " + gunGroup.rotation.z + ", gunGroup.position.x: " + gunGroup.position.x);
                    }

                    if (gunTrigger_progress <= 1) {
                        gunTrigger.rotation.z = -0.3 * gunTrigger_progress;
                    } else {
                        gunTrigger.rotation.z = -0.3

                        if (!r_gunTrigger_now) {
                            r_gunTrigger_now = Date.now();
                        }

                        const r_gunTrigger_progress = (now - r_gunTrigger_now) / r_gunTrigger_duration;

                        if (r_gunTrigger_progress <= 1) {
                            gunTrigger.rotation.z = -0.3 * (1 - r_gunTrigger_progress);
                        } else {
                            gunTrigger.rotation.z = 0;
                            isAnimating = false; //put this at the end of the longest part of the animation
                        }
                    }

                    if (gunBolt_progress <= 1) {
                        gunBolt.position.x = -20 * gunBolt_progress;
                    } else {
                        gunBolt.position.x = -20;

                        //start reverse
                        if (!r_gunBolt_now) {
                            r_gunBolt_now = Date.now();
                        }

                        const r_gunBolt_progress = (now - r_gunBolt_now) / r_gunBolt_duration;

                        if (r_gunBolt_progress <= 1) {
                            gunBolt.position.x = -20 * (1 - r_gunBolt_progress);
                        } else {
                            gunBolt.position.x = 0;
                        }
                    }

                    requestAnimationFrame(animateGun);
                }

                animateGun();
            }
        }
        document.addEventListener('keydown', onKeyDown);

        // render function
        const render = function () {
            requestAnimationFrame(render);
            renderer.render(scene, camera);
        };

        render();
    </script>
</body>

</html>